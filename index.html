<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detailed Player Statistics</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.tailwindcss.css">
    
    <style>
        /* Custom styling for better presentation */
        body { background-color: #f3f4f6; font-family: 'Inter', sans-serif; padding: 20px; }
        .dt-container {
            max-width: 100%; 
            overflow-x: auto; /* CRITICAL for many columns */
            background: white; 
            padding: 1.5rem; 
            border-radius: 0.75rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Style for Gameweek columns */
        #myTable th.gw-col, #myTable td.gw-col {
            text-align: center;
            width: 50px; /* Narrower width for GW columns */
            white-space: nowrap;
        }
        /* Ensure the DataTables search/info bars look good */
        .dt-search, .dt-info {
            padding: 0.5rem 0;
        }
        /* Abbreviated header style for better tooltips */
        .abbrev-header {
            cursor: help;
        }
    </style>
</head>
<body>

    <div class="container mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">
            Fantasy Player Statistics Detail
        </h1>
        <p class="text-gray-600 mb-6 text-center text-sm">
            <span class="font-bold text-red-500">Note:</span> Player Value is mocked as 10.0M in the Python script. Hover over column headers for full names.
        </p>
        
        <div class="dt-container">
            <table id="myTable" class="display w-full text-sm text-left text-gray-700 dataTables_wrapper stripe hover">
                <thead>
                    <!-- Header content will be generated by DataTables using column definitions -->
                </thead>
                <tbody>
                    <!-- Data will be inserted here by DataTables -->
                </tbody>
            </table>
        </div>
        
    </div>

    <!-- Load jQuery (required by DataTables) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Load DataTables JS and the Tailwind integration script -->
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.tailwindcss.min.js"></script>

    <script>
    $(document).ready(function() {
        const AJAX_URL = 'transformed_data.json';
        const RECENT_GAMES_COUNT = 6;
        
        // Helper function to create the abbreviated header with a tooltip
        function createHeader(abbr, fullTitle) {
            return `<span class="abbrev-header" title="${fullTitle}">${abbr}</span>`;
        }

        // 1. Define the static columns
        let columns = [
            { data: 'Name', title: 'Name', className: 'font-bold text-gray-800' },
            { data: 'Club', title: createHeader('Club', 'Club'), className: 'whitespace-nowrap' },
            { data: 'Position', title: createHeader('Pos', 'Position') },
            // Value is now a number (10.0), let's render it as a currency string
            { data: 'Value', title: createHeader('Value', 'Player Value (M)'), render: (data) => `${data.toFixed(1)}M`, className: 'text-right' },
            
            // Core Performance Metrics
            { data: 'Total Points', title: createHeader('Total Pts', 'Total Points'), className: 'text-center font-bold' },
            { data: 'Total Games Played', title: createHeader('GP', 'Total Games Played'), className: 'text-center' },
            { data: 'Points Per Game', title: createHeader('PPG', 'Points Per Game'), render: (data) => data.toFixed(2), className: 'text-right font-semibold' },
            
            // Recent Performance Metrics
            { data: `Total Over ${RECENT_GAMES_COUNT} Games`, title: createHeader(`Pts (L${RECENT_GAMES_COUNT})`, `Total Points Over Last ${RECENT_GAMES_COUNT} Games`), className: 'text-center' },
            { data: 'Games Played Over 6 Games', title: createHeader(`GP (L${RECENT_GAMES_COUNT})`, `Games Played Over Last ${RECENT_GAMES_COUNT} Games`), className: 'text-center' },
            { data: 'Points Per Game Over 6 Games', title: createHeader(`PPG (L${RECENT_GAMES_COUNT})`, `Points Per Game Over Last ${RECENT_GAMES_COUNT} Games`), render: (data) => data.toFixed(2), className: 'text-right' },
            
            // Efficiency Metrics
            { data: 'Points Per Million', title: createHeader('Pts/M', 'Points Per Million'), render: (data) => data.toFixed(2), className: 'text-right' },
            { data: 'Points Per Million Over 6 Games', title: createHeader(`Pts/M (L${RECENT_GAMES_COUNT})`, `Points Per Million Over Last ${RECENT_GAMES_COUNT} Games`), render: (data) => data.toFixed(2), className: 'text-right' },
            
            // Contribution Stats (Abbreviated headers)
            { data: 'Total Goals', title: createHeader('G', 'Total Goals'), className: 'text-center' },
            { data: 'Total Assists', title: createHeader('A', 'Total Assists'), className: 'text-center' },
            { data: 'Total Clean Sheet', title: createHeader('CS', 'Total Clean Sheet'), className: 'text-center' },
            { data: 'Total Bonus Points', title: createHeader('BP', 'Total Bonus Points'), className: 'text-center' },
            { data: 'Total Yellow Cards', title: createHeader('YC', 'Total Yellow Cards'), className: 'text-center' },
            { data: 'Total Red Cards', title: createHeader('RC', 'Total Red Cards'), className: 'text-center' },
            { data: 'Total Missed Penalties', title: createHeader('MP', 'Total Missed Penalties'), className: 'text-center' },
            { data: 'Total Clearances', title: createHeader('CL', 'Total Clearances'), className: 'text-center' },
            { data: 'Total Conceeded', title: createHeader('GC', 'Total Goals Conceded'), className: 'text-center' },
            { data: 'Total 1 min Appearances', title: createHeader('1m App', 'Total 1 min Appearances'), className: 'text-center' },
            { data: 'Total 60 min Appearances', title: createHeader('60m App', 'Total 60 min Appearances'), className: 'text-center' },
        ];

        // 2. Fetch the data to determine the dynamic Gameweek columns
        $.ajax({
            url: AJAX_URL,
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                if (!data || data.length === 0) {
                    console.error("No data received from JSON file.");
                    $('#myTable').html('<p class="text-center text-xl p-8">No player data available to display. Ensure transformed_data.json is generated.</p>');
                    return;
                }

                // Identify all unique Gameweek keys from the first player's data 
                const firstPlayer = data[0];
                const gameweekKeys = Object.keys(firstPlayer).filter(key => key.startsWith('GW')).sort((a, b) => {
                    // Sort descending (GW5, GW4, GW3...)
                    return parseInt(b.replace('GW', '')) - parseInt(a.replace('GW', ''));
                });
                
                // Add the dynamic Gameweek columns to the array
                gameweekKeys.forEach(gwKey => {
                    columns.push({
                        data: gwKey, 
                        title: createHeader(gwKey.replace('GW', 'GW'), `Gameweek ${gwKey.replace('GW', '')} Points`),
                        className: 'gw-col' // Use custom style for centering/sizing
                    });
                });

                // 3. Initialize DataTables with the complete column definition
                $('#myTable').DataTable({
                    data: data, // Use the already fetched data
                    columns: columns,
                    // Configuration for the wide table
                    paging: true,
                    searching: true,
                    scrollX: true, // Allows horizontal scrolling for many columns
                    order: [[4, 'desc']], // Sort by Total Points initially (index 4)
                    responsive: false, // Turn off default responsiveness 
                    info: true,
                    language: {
                        search: "Filter All Columns:",
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    }
                });
            },
            error: function(xhr, status, error) {
                console.error("AJAX Error:", status, error);
                $('#myTable').html('<p class="text-center text-xl p-8 text-red-600">Failed to load data. Ensure transformed_data.json exists and is valid.</p>');
            }
        });
    });
    </script>

</body>
</html>
